// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Defaulting to PostgreSQL, change if needed
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum UserRole {
  SuperAdmin
  Admin
  GovernorAdmin
  ProjectManager
  Contractor
  FinanceOfficer
  ProcurementOfficer
  Vendor
  Auditor
  MeetingUser
}

enum ProjectStatus {
  Planned
  InProgress
  Delayed
  Completed
}

enum ProjectCategory {
  Infrastructure
  Healthcare
  Education
  Agriculture
  Technology
  Environment
  Housing
}

enum MilestoneStage {
  PreConstruction
  Foundation
  Superstructure
  Finishing
  TestingCommissioning
  Handover
}

enum SubmissionStatus {
  Pending
  Approved
  Rejected
}

enum ProcurementStatus {
  Open
  Bidding
  Awarded
  Closed
}

enum BidStatus {
  Submitted
  Rejected
  Awarded
}

enum AuditModule {
  Budget
  Expenditure
  Revenue
  Procurement
  Project
}

enum DiscrepancyStatus {
  Open
  Resolved
  Escalated
}

enum EventStatus {
  on_track  @map("on-track")
  delayed
  completed
  planned
}

enum EventPriority {
  high
  medium
  low
}

// =====================================================
// MODELS
// =====================================================

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  firstname          String
  lastname           String
  role               UserRole
  mdaId              String?
  mda                MDA?      @relation(fields: [mdaId], references: [id])
  password           String? // Added for auth
  status             String    @default("active") // Replaces isActive, matches TypeScript type
  lastLogin          DateTime?
  mustChangePassword Boolean   @default(false)
  passwordChangedAt  DateTime?
  permissions        Json? // RBAS: JSON field storing permissions in action_module format

  // Relations
  contractorProjects Project[] @relation("Contractor")
  supervisedProjects Project[] @relation("Supervisor")

  submittedMilestones MilestoneSubmission[] @relation("ContractorSubmission")
  reviewedMilestones  MilestoneSubmission[] @relation("Reviewer")

  bids   Bid[]
  awards Award[]

  discrepancies DiscrepancyRemark[]

  createdPayments   Payment[] @relation("CreatedPayments")
  submittedPayments Payment[] @relation("SubmittedPayments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MDA {
  id          String  @id @default(cuid())
  name        String
  category    String
  description String?
  headOfMda   String?
  email       String?
  phone       String?
  address     String?
  isActive    Boolean @default(true)

  // Relations
  users               User[]
  supervisedProjects  Project[] // projects supervised by this MDA
  budgetAllocations   BudgetAllocation[]
  revenues            Revenue[]
  procurementRequests ProcurementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id          String          @id @default(cuid())
  title       String
  description String
  category    ProjectCategory

  supervisingMdaId String?
  supervisingMda   MDA?    @relation(fields: [supervisingMdaId], references: [id])

  contractorId String?
  contractor   User?   @relation("Contractor", fields: [contractorId], references: [id])

  contractValue     Float
  startDate         DateTime
  endDate           DateTime
  status            ProjectStatus
  evidenceDocs      String[] // Array of URLs

  supervisorId String?
  supervisor   User?   @relation("Supervisor", fields: [supervisorId], references: [id])

  // Relations
  milestones   MilestoneSubmission[]
  expenditures Expenditure[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MilestoneSubmission {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  contractorId String
  contractor   User   @relation("ContractorSubmission", fields: [contractorId], references: [id])

  milestoneStage  MilestoneStage
  percentComplete Float
  notes           String?

  // GeoLocation
  geoTag Json?

  evidenceDocs String[]
  status       SubmissionStatus

  reviewedBy String?
  reviewer   User?     @relation("Reviewer", fields: [reviewedBy], references: [id])
  reviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BudgetAllocation {
  id             String   @id @default(cuid())
  mdaId          String
  mda            MDA      @relation(fields: [mdaId], references: [id])
  fiscalYear     Int
  quarter        Int
  amount         Float
  source         String
  supportingDocs String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Expenditure {
  id             String   @id @default(cuid())
  projectId      String
  project        Project  @relation(fields: [projectId], references: [id])
  amount         Float
  date           DateTime
  recipient      String
  supportingDocs String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Revenue {
  id             String   @id @default(cuid())
  mdaId          String
  mda            MDA      @relation(fields: [mdaId], references: [id])
  type           String
  amount         Float
  date           DateTime
  supportingDocs String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProcurementRequest {
  id            String            @id @default(cuid())
  mdaId         String
  mda           MDA               @relation(fields: [mdaId], references: [id])
  title         String
  description   String
  estimatedCost Float
  requestDate   DateTime
  status        ProcurementStatus
  documents     String[]

  // Relations
  bids   Bid[]
  awards Award[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bid {
  id                   String             @id @default(cuid())
  procurementRequestId String
  procurementRequest   ProcurementRequest @relation(fields: [procurementRequestId], references: [id])

  vendorId String
  vendor   User   @relation(fields: [vendorId], references: [id])

  bidAmount      Float
  proposalDocs   String[]
  complianceDocs String[]
  status         BidStatus
  submittedAt    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Award {
  id                   String             @id @default(cuid())
  procurementRequestId String
  procurementRequest   ProcurementRequest @relation(fields: [procurementRequestId], references: [id])

  vendorId String
  vendor   User   @relation(fields: [vendorId], references: [id])

  contractValue Float
  awardDate     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Meeting {
  id             String   @id @default(cuid())
  title          String
  agendaDocs     String[]
  participants   String[] // Array of User IDs or emails if external
  scheduledAt    DateTime
  locationOrLink String

  minutes MeetingMinutes?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MeetingMinutes {
  id          String   @id @default(cuid())
  meetingId   String   @unique
  meeting     Meeting  @relation(fields: [meetingId], references: [id])
  decisions   String[]
  // ActionItems would ideally be a separate model, but storing as Json for simplicity based on types
  actionItems Json[]
  attachments String[]
  recordedAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiscrepancyRemark {
  id         String            @id @default(cuid())
  entityId   String
  module     AuditModule
  auditorId  String
  auditor    User              @relation(fields: [auditorId], references: [id])
  comment    String
  status     DiscrepancyStatus
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CalendarEvent {
  id          String         @id @default(cuid())
  title       String
  date        DateTime
  startTime   String?
  endTime     String?
  project     String?
  status      EventStatus?
  priority    EventPriority?
  description String?
  contractor  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// PAYMENTS
// =====================================================

enum PaymentSourceType {
  project
  requestForm
  payroll
}

enum PaymentStatus {
  draft
  pending_approval
  approved
  processing
  paid
  failed
  cancelled
  partially_paid
}

enum PaymentMethod {
  bank_transfer
  check
  cash
  mobile_money
  card
}

model Payment {
  id            String            @id @default(cuid())
  sourceType    PaymentSourceType
  projectId     String?
  requestFormId String?
  payrollId     String?

  createdById   String
  createdBy     User     @relation("CreatedPayments", fields: [createdById], references: [id])
  submittedById String?
  submittedBy   User?    @relation("SubmittedPayments", fields: [submittedById], references: [id])
  approverIds   String[] // Array of User IDs

  payeeId        String?
  payerAccountId String?

  currency          String
  exchangeRate      Float?
  isForeignCurrency Boolean @default(false)

  amount             Float
  taxAmount          Float  @default(0)
  totalAmount        Float
  fxAppliedAmount    Float?
  balanceOutstanding Float  @default(0)

  status PaymentStatus @default(draft)
  method PaymentMethod @default(bank_transfer)

  paymentDate  String? // ISO Date string
  dueDate      String? // ISO Date string
  scheduledFor String? // ISO Date string

  notes     String?
  reference String?
  tags      String[]

  requiresApproval     Boolean @default(false)
  isDraft              Boolean @default(true)
  isLocked             Boolean @default(false)
  isArchived           Boolean @default(false)
  isRecurring          Boolean @default(false)
  recurrenceTemplateId String?

  derivedFromRequestFormItems Boolean  @default(false)
  requestFormItemIds          String[]

  attachments          String[]
  auditLog             Json?
  reconciliationStatus String?
  reconciliationDate   DateTime?
  ledgerEntryIds       String[]
  cancellationReason   String?

  items        PaymentItem[]
  installments PaymentInstallment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentItem {
  id        String  @id @default(cuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  description String
  quantity    Float  @default(1)
  unitPrice   Float
  currency    String
  taxRate     Float  @default(0)
  taxAmount   Float  @default(0)
  total       Float

  requestFormItemId String?
  metadata          Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentInstallment {
  id        String  @id @default(cuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  dueDate   String // ISO Date string
  amount    Float
  status    PaymentStatus @default(pending_approval)
  paidAt    DateTime?
  reference String?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// AUDIT LOGGING
// =====================================================

enum AuditActionType {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
}

enum AuditStatus {
  SUCCESS
  FAILED
  PENDING
}

model AuditLog {
  id          String          @id @default(cuid())
  actor       String // User ID or name who performed the action
  entity      String // Entity type (e.g., "Project", "User", "Budget")
  entityId    String? // ID of the affected entity
  actionType  AuditActionType
  status      AuditStatus
  before      Json? // Complete data before change
  after       Json? // Complete data after change
  description String // Human-readable description
  timestamp   DateTime        @default(now())
  ipAddress   String? // Optional: Track IP address
  userAgent   String? // Optional: Track user agent

  @@index([actor])
  @@index([entity])
  @@index([timestamp])
  @@index([actionType])
}

model RolePermissionTemplate {
  id          String   @id @default(cuid())
  role        UserRole @unique
  permissions Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([role])
  @@map("role_permission_templates")
}


// =====================================================
// PERMISSIONS
// =====================================================
